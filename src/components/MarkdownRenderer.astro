---
import { unified } from "unified";
import remarkParse from "remark-parse";
import remarkRehype from "remark-rehype";
import rehypeStringify from "rehype-stringify";
import rehypeShiki from "@shikijs/rehype";
import remarkGfm from "remark-gfm";
import remarkFootnotes from "../plugins/remark-footnotes.mjs";
import remarkCallout from "../plugins/remark-callout.mjs";
import remarkMath from "remark-math";
import remarkMathFlag from "../plugins/remark-math-flag.mjs";
import rehypeResolveInternalLinks from "../plugins/rehype-resolve-internal-links.mjs";
import rehypeMarkExternalLinks from "../plugins/rehype-mark-external-links.mjs";
import rehypeSlug from "../plugins/rehype-slug.mjs";
import rehypeKatex from "rehype-katex";
import { visit } from "unist-util-visit";
import { PathMapper } from "../utils/path-mapper/path-mapper.js";
import path from "path";

interface Props {
  content: string; // åŸå§‹ markdown æ–‡æœ¬
  filePath: string; // æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äº content ç›®å½•ï¼Œå¦‚ "blog/test.md"ï¼‰
}

const { content, filePath } = Astro.props;

// æ„å»º file pathï¼ˆç”¨äº rehype æ’ä»¶ï¼‰
const contentDir = "src/content/blog";
const fullPath = path.join(process.cwd(), contentDir, filePath);

// ç¡®ä¿ PathMapper å·²æ„å»º
const mapper = await PathMapper.getInstance({ contentDir });

// è·å–æ‰€æœ‰å›¾ç‰‡èµ„æºæ˜ å°„
const images = import.meta.glob(
  "/src/content/blog/**/*.{png,jpg,jpeg,gif,svg,webp}",
  {
    eager: true,
    query: "?url",
    import: "default",
  },
);

/**
 * Rehype æ’ä»¶ï¼šè§£æç›¸å¯¹è·¯å¾„å›¾ç‰‡
 */
function rehypeResolveRelativeAssets() {
  return (tree: any) => {
    visit(tree, "element", (node: any) => {
      if (node.tagName === "img" && node.properties && node.properties.src) {
        const src = node.properties.src as string;

        // åˆ¤æ–­æ˜¯å¦ä¸ºç›¸å¯¹è·¯å¾„ï¼šä¸ä»¥ / å¼€å¤´ï¼Œä¸”ä¸æ˜¯ç»å¯¹ URI (http, data, etc.)
        const isAbsolute = src.startsWith("/") || src.startsWith("\\");
        const isUri = /^[a-z]+:/i.test(src);

        if (!isAbsolute && !isUri) {
          try {
            // è§£ç  src (å¤„ç† URL ç¼–ç å­—ç¬¦)
            const decodedSrc = decodeURI(src);

            // è®¡ç®—å›¾ç‰‡çš„ç»å¯¹è·¯å¾„
            const imageAbsPath = path.resolve(
              path.dirname(fullPath),
              decodedSrc,
            );

            // è®¡ç®—ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„ï¼ˆç”¨äºåŒ¹é… glob keyï¼‰
            let relPath = path.relative(process.cwd(), imageAbsPath);
            // ç»Ÿä¸€åˆ†éš”ç¬¦ä¸º /
            relPath = relPath.split(path.sep).join("/");

            // æ„é€  key (ç¡®ä¿ä»¥ / å¼€å¤´)
            const key = "/" + relPath;

            // æŸ¥æ‰¾èµ„æº
            const resolvedUrl = (images as Record<string, string>)[key];

            if (resolvedUrl) {
              node.properties.src = resolvedUrl;
            } else {
              // å°è¯•ä¸è§£ç çš„æƒ…å†µ (Fallback)
              const imageAbsPathRaw = path.resolve(path.dirname(fullPath), src);
              let relPathRaw = path.relative(process.cwd(), imageAbsPathRaw);
              relPathRaw = relPathRaw.split(path.sep).join("/");
              const keyRaw = "/" + relPathRaw;
              const resolvedUrlRaw = (images as Record<string, string>)[keyRaw];

              if (resolvedUrlRaw) {
                node.properties.src = resolvedUrlRaw;
              } else {
                console.warn(
                  `[MarkdownRenderer] Could not resolve image: ${src} in ${filePath}. Key searched: ${key}`,
                );
              }
            }
          } catch (e) {
            console.error(
              `[MarkdownRenderer] Error parsing image src: ${src}`,
              e,
            );
          }
        }
      }
    });
  };
}

// åˆ›å»ºå¤„ç†å™¨
const processor = unified()
  .use(remarkParse)
  .use(remarkGfm) // Support GFM features like tables
  .use(remarkFootnotes) // Support footnotes [^1]
  .use(remarkMath)
  .use(remarkMathFlag)
  .use(remarkCallout)
  .use(remarkRehype, { allowDangerousHtml: true })
  .use(rehypeResolveRelativeAssets) // è§£æç›¸å¯¹è·¯å¾„å›¾ç‰‡ - éœ€åœ¨å…¶ä»– rehype æ’ä»¶å‰æ‰§è¡Œï¼Œæˆ–å°½æ—©æ‰§è¡Œ
  .use(rehypeSlug) // Add stable IDs to headings
  .use(rehypeResolveInternalLinks, { contentDir })
  .use(rehypeMarkExternalLinks)
  .use(rehypeKatex, { output: "html" })
  .use(rehypeShiki, {
    themes: {
      light: "github-light",
      dark: "github-dark",
    },
    langs: [
      "javascript",
      "typescript",
      "python",
      "java",
      "rust",
      "go",
      "bash",
      "markdown",
      "html",
      "css",
      "json",
      "yaml",
      "xml",
      "sql",
      "php",
      "c",
      "cpp",
      "csharp",
      "ruby",
      "swift",
      "kotlin",
      "dart",
      "scala",
      "haskell",
      "lua",
      "perl",
      "r",
      "matlab",
      "nginx",
      "apache",
      "dockerfile",
      "vim",
      "shell",
      "powershell",
      "plaintext",
    ],
  })
  .use(rehypeStringify, { allowDangerousHtml: true });

// å¤„ç† markdown
const vfile = await processor.process({
  value: content,
  path: fullPath,
});

const htmlContent = String(vfile);
---

<article set:html={htmlContent} />

<style>
  /* Callout æ ·å¼ */
  .callout {
    margin: 1rem 0;
    padding: 0;
    border-radius: 0.5rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .callout-title {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    font-weight: 600;
    font-size: 0.875rem;
    background: rgba(0, 0, 0, 0.03);
  }

  .callout-icon {
    margin-right: 0.5rem;
    font-size: 1.125rem;
  }

  .callout-content {
    padding: 0.75rem 1rem;
  }

  /* Callout é¢œè‰²å˜ä½“ */
  .callout.info {
    border-color: rgba(59, 130, 246, 0.3);
  }
  .callout.info .callout-title {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
  }
  .callout.info .callout-icon::before {
    content: "â„¹ï¸";
  }

  .callout.tip {
    border-color: rgba(34, 197, 94, 0.3);
  }
  .callout.tip .callout-title {
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
  }
  .callout.tip .callout-icon::before {
    content: "ğŸ’¡";
  }

  .callout.warning {
    border-color: rgba(245, 158, 11, 0.3);
  }
  .callout.warning .callout-title {
    background: rgba(245, 158, 11, 0.1);
    color: #92400e;
  }
  .callout.warning .callout-icon::before {
    content: "âš ï¸";
  }

  .callout.danger {
    border-color: rgba(239, 68, 68, 0.3);
  }
  .callout.danger .callout-title {
    background: rgba(239, 68, 68, 0.1);
    color: #991b1b;
  }
  .callout.danger .callout-icon::before {
    content: "ğŸ”¥";
  }

  /* Callout çš„å…¶ä»–é¢œè‰²å˜ä½“ */
  .callout.note {
    border-color: rgba(107, 114, 128, 0.3);
  }
  .callout.note .callout-title {
    background: rgba(107, 114, 128, 0.1);
    color: #374151;
  }
  .callout.note .callout-icon::before {
    content: "ğŸ“";
  }

  .callout.success {
    border-color: rgba(34, 197, 94, 0.3);
  }
  .callout.success .callout-title {
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
  }
  .callout.success .callout-icon::before {
    content: "âœ…";
  }

  .callout.error {
    border-color: rgba(239, 68, 68, 0.3);
  }
  .callout.error .callout-title {
    background: rgba(239, 68, 68, 0.1);
    color: #991b1b;
  }
  .callout.error .callout-icon::before {
    content: "âŒ";
  }

  .callout.question {
    border-color: rgba(59, 130, 246, 0.3);
  }
  .callout.question .callout-title {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
  }
  .callout.question .callout-icon::before {
    content: "â“";
  }

  /* æ·±è‰²æ¨¡å¼é€‚é… */
  @media (prefers-color-scheme: dark) {
    .callout {
      border-color: rgba(255, 255, 255, 0.1);
    }

    .callout-title {
      background: rgba(255, 255, 255, 0.05);
    }
  }

  html.dark .callout {
    border-color: rgba(255, 255, 255, 0.1);
  }

  html.dark .callout-title {
    background: rgba(255, 255, 255, 0.05);
  }

  /* ä»£ç å—æ ·å¼ - ç¡®ä¿ä¸ Shiki è¾“å‡ºå…¼å®¹ */
  pre {
    position: relative;
    overflow-x: auto;
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 0.5rem;
  }

  pre code {
    display: block;
    font-family:
      ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  /* è¡¨æ ¼æ ·å¼ */
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    overflow: hidden;
  }

  th,
  td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--lightgray);
  }

  th {
    font-weight: 600;
    background-color: var(--highlight);
    color: var(--dark);
  }

  tr:last-child td {
    border-bottom: none;
  }

  tr:hover {
    background-color: var(--highlight);
  }

  /* è„šæ³¨æ ·å¼ */
  .footnotes {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid var(--lightgray);
    font-size: 0.85rem;
  }

  .footnotes h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
    color: var(--dark);
  }

  .footnotes ol {
    padding-left: 1.5rem;
    margin: 0;
  }

  .footnotes li {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
    line-height: 1.6;
  }

  .footnotes .footnote-backref {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    background-color: var(--highlight);
    border-radius: 4px;
    padding: 0 0.4rem;
    margin-left: 0.5rem;
    font-size: 0.75rem;
    color: var(--secondary);
    transition: all 0.2s;
  }

  .footnotes .footnote-backref:hover {
    background-color: var(--secondary);
    color: var(--light);
  }

  sup a {
    background-color: var(--highlight);
    border-radius: 4px;
    padding: 0 0.3rem;
    font-size: 0.75rem;
    text-decoration: none;
    color: var(--secondary);
    font-weight: 600;
    transition: all 0.2s;
  }

  sup a:hover {
    background-color: var(--secondary);
    color: var(--light);
  }
</style>

<script type="module">
  // ä»£ç å¤åˆ¶åŠŸèƒ½ - åœ¨å®¢æˆ·ç«¯åŠ¨æ€æ·»åŠ æŒ‰é’®
  document.addEventListener("DOMContentLoaded", () => {
    // æŸ¥æ‰¾æ‰€æœ‰ pre å…ƒç´ 
    const pres = document.querySelectorAll("pre");

    pres.forEach((pre) => {
      // è·³è¿‡å·²ç»æœ‰å¤åˆ¶æŒ‰é’®çš„ pre
      if (pre.querySelector(".shiki-copy-button")) {
        return;
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºä»£ç å—
      const code = pre.querySelector("code");
      if (!code) return;

      // åˆ›å»ºå¤åˆ¶æŒ‰é’®
      const button = document.createElement("button");
      button.className = "shiki-copy-button";
      button.type = "button";
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/>
          <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/>
        </svg>
      `;

      // æ ·å¼
      Object.assign(button.style, {
        position: "absolute",
        top: "0.5rem",
        right: "0.5rem",
        padding: "0.25rem 0.5rem",
        fontSize: "0.75rem",
        background: "rgba(0, 0, 0, 0.1)",
        border: "1px solid rgba(0, 0, 0, 0.2)",
        borderRadius: "0.25rem",
        cursor: "pointer",
        transition: "background-color 0.2s, opacity 0.2s",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "10",
      });

      // åªæœ‰åœ¨æ”¯æŒ hover çš„è®¾å¤‡ä¸Šæ‰é»˜è®¤éšè—ï¼Œhover æ—¶æ˜¾ç¤º
      pre.style.position = "relative";
      if (window.matchMedia("(hover: hover)").matches) {
        button.style.opacity = "0";

        const show = () => (button.style.opacity = "1");
        const hide = () => (button.style.opacity = "0");

        pre.addEventListener("mouseenter", show);
        pre.addEventListener("mouseleave", hide);

        // é”®ç›˜è®¿é—®æ”¯æŒ
        button.addEventListener("focus", show);
        button.addEventListener("blur", hide);
      } else {
        button.style.opacity = "1";
      }

      // æ·±è‰²æ¨¡å¼é€‚é…
      const isDark =
        document.documentElement.classList.contains("dark") ||
        document.documentElement.getAttribute("data-theme") === "dark" ||
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (isDark) {
        button.style.background = "rgba(255, 255, 255, 0.1)";
        button.style.borderColor = "rgba(255, 255, 255, 0.2)";
      }

      // æ‚¬åœæ•ˆæœ
      button.addEventListener("mouseenter", () => {
        button.style.background = isDark
          ? "rgba(255, 255, 255, 0.2)"
          : "rgba(0, 0, 0, 0.2)";
      });
      button.addEventListener("mouseleave", () => {
        button.style.background = isDark
          ? "rgba(255, 255, 255, 0.1)"
          : "rgba(0, 0, 0, 0.1)";
      });

      // å¤åˆ¶åŠŸèƒ½
      button.addEventListener("click", async () => {
        const text = code.innerText;

        try {
          await navigator.clipboard.writeText(text);

          // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
          button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="#22c55e">
              <path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/>
            </svg>
          `;

          setTimeout(() => {
            button.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/>
                <path fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/>
              </svg>
            `;
          }, 2000);
        } catch (err) {
          console.error("Failed to copy code:", err);
        }
      });

      pre.appendChild(button);
    });
  });
</script>
