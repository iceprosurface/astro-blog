---
import { SITE_TITLE } from "../consts";
import LatestPosts from "./LatestPosts.astro";
import { Folder, Tag } from "@lucide/astro";
---

<aside class="sidebar">
	<div class="sidebar-content">
		<!-- 第一行：标题 -->
		<div class="sidebar-title">
			<a href="/">{SITE_TITLE}</a>
		</div>

		<!-- 第二行：搜索 + 主题切换 -->
		<div class="sidebar-controls">
			<div class="sidebar-search" id="sidebar-search-btn">
				<div class="search-box">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 19.9 19.7"
						width="18"
						height="18"
					>
						<g
							class="search-path"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
						>
							<path
								stroke-linecap="square"
								d="M18.5 18.3l-5.4-5.4"></path>
							<circle cx="8" cy="8" r="7"></circle>
						</g>
					</svg>
					<span>搜索...</span>
				</div>
			</div>

			<button
				id="sidebar-dark-mode-toggle"
				class="sidebar-theme-toggle"
				aria-label="Toggle dark mode"
			>
				<svg
					class="sun-icon"
					xmlns="http://www.w3.org/2000/svg"
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<circle cx="12" cy="12" r="5"></circle>
					<line x1="12" y1="1" x2="12" y2="3"></line>
					<line x1="12" y1="21" x2="12" y2="23"></line>
					<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
					<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
					<line x1="1" y1="12" x2="3" y2="12"></line>
					<line x1="21" y1="12" x2="23" y2="12"></line>
					<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
					<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
				</svg>
				<svg
					class="moon-icon"
					xmlns="http://www.w3.org/2000/svg"
					width="20"
					height="20"
					viewBox="0 0 100 100"
					fill="currentColor"
				>
					<path
						d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"
					></path>
				</svg>
			</button>
		</div>

		<!-- 第三行：最新文章 -->
		<div class="sidebar-latest">
			<LatestPosts />
		</div>

		<!-- 第四行：导航链接 (只保留标签) -->
		<nav class="sidebar-nav">
			<a href="/folder" class="nav-link">
				<Folder size={18} />
				目录
			</a>
			<a href="/tags" class="nav-link">
				<Tag size={18} />
				标签
			</a>
		</nav>
	</div>
</aside>

<script>
	const toggle = document.getElementById("sidebar-dark-mode-toggle");
	const html = document.documentElement;

	// Note: Theme initialization is now handled in BaseHead.astro to prevent FOUC

	toggle?.addEventListener("click", () => {
		const isNowDark = html.classList.toggle("dark");
		localStorage.setItem("darkMode", isNowDark ? "true" : "false");
		html.setAttribute("saved-theme", isNowDark ? "dark" : "light");
	});
</script>

<style>
	.sidebar {
		width: 280px;
		flex-shrink: 0;
		background: var(--light);
		border-right: 1px solid var(--lightgray);
		height: 100vh;
		position: sticky;
		top: 0;
		overflow-y: auto;
		transition: background-color 0.3s ease;
		z-index: 100;
	}

	.sidebar-content {
		padding: 2rem 1.5rem;
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	/* 第一行：标题 */
	.sidebar-title {
		margin-bottom: 0.5rem;
	}

	.sidebar-title a {
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--dark);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.sidebar-title a:hover {
		color: var(--secondary);
	}

	/* 第二行：控件区域 (搜索 + 主题) */
	.sidebar-controls {
		display: flex;
		gap: 0.8rem;
		align-items: stretch;
	}

	.sidebar-search {
		flex: 1;
		cursor: pointer;
		min-width: 0; /* 防止溢出 */
	}

	.search-box {
		background-color: var(--lightgray);
		border-radius: 6px;
		padding: 0.6rem 0.8rem;
		display: flex;
		align-items: center;
		gap: 0.5rem;
		transition: all 0.2s ease;
		height: 100%;
		white-space: nowrap;
		overflow: hidden;
		box-sizing: border-box;
	}

	.search-box:hover {
		background-color: var(--highlight);
	}

	.search-box svg {
		color: var(--darkgray);
		flex-shrink: 0;
		width: 16px;
		height: 16px;
	}

	.search-box span {
		font-size: 0.9rem;
		color: var(--darkgray);
		overflow: hidden;
		text-overflow: ellipsis;
	}

	/* 主题切换按钮 (仅图标) */
	.sidebar-theme-toggle {
		background: var(--lightgray); /* 与搜索框稍微融合，或者 transparent */
		border: none;
		border-radius: 6px;
		padding: 0 0.8rem;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--darkgray);
		transition: all 0.2s ease;
		flex-shrink: 0;
	}

	.sidebar-theme-toggle:hover {
		background-color: var(--highlight);
		color: var(--secondary);
	}

	.sun-icon {
		display: block;
	}
	.moon-icon {
		display: none;
	}

	:global(.dark) .sun-icon {
		display: none;
	}
	:global(.dark) .moon-icon {
		display: block;
	}

	/* 第四行：导航链接 */
	.sidebar-nav {
		padding-top: 0.5rem;
		display: flex;
		flex-direction: row;
		gap: 0.8rem;
	}

	.nav-link {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		padding: 0.6rem;
		color: var(--darkgray);
		text-decoration: none;
		border-radius: 6px;
		transition: all 0.2s ease;
		font-weight: 500;
		font-size: 0.95rem;
		flex: 1;
		background-color: var(--lightgray);
	}

	.nav-link:hover {
		background-color: var(--lightgray);
		color: var(--secondary);
	}

	.nav-icon {
		width: 1.1rem;
		height: 1.1rem;
		opacity: 0.8;
	}

	/* 响应式：在小屏幕上隐藏 */
	@media (max-width: 900px) {
		.sidebar {
			display: none;
		}
	}

	/* 第三行：最新文章 */
	.sidebar-latest {
		padding-top: 1.5rem;
		border-top: 1px solid var(--lightgray);
	}
</style>
